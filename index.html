<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Music</title>

    <!-- import the webpage's javascript file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.22/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tensorflow/4.22.0/tf.min.js"></script>
    <!-- Core library, since we're going to use a player -->
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.23.1/es6/core.js"></script>
    <!--Model we want to use -->
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.23.1/es6/music_vae.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.23.1/es6/protobuf.js"></script>
    <script src="scripts/split.js"></script>
    <script defer>
      fetch('checkpoints.json')
  .then((response) => {
    if (!response.ok) {
      throw new Error(`HTTP error: ${response.status}`);
    }
    return response.json();
  })
  .then((json) => {
    json.map( (checkpoint, i) => {
      if (checkpoint.model=='MusicVAE') {
        let opt = document.createElement("option");
        opt.value = checkpoint.url;
        opt.innerHTML = checkpoint.id;
        modelSelect.append(opt);
      }
    });
  })
  .catch((err) => console.error(`Fetch problem: ${err.message}`));
      const player = new core.Player();
      (async function() {
        const elise = await core.urlToNoteSequence('https://bitmidi.com/uploads/28362.mid');
        console.log(elise);
        const sequences = split(elise);
        console.log(sequences);
        const chunks = [];
        for (let seq of sequences.chunks) {
            chunks.push(core.sequences.quantizeNoteSequence(seq, 4));
        }
        console.log(chunks);
        let splitSong = core.sequences.concatenate(chunks);
        //console.log('merged', core.sequences.unquantizeSequence(splitSong));
        console.log('merged', splitSong);
        const jazzSeed = {
            notes: [
                { pitch: 60, startTime: 0, endTime: 0.5 },
                { pitch: 63, startTime: 0.5, endTime: 1 },
                { pitch: 67, startTime: 1, endTime: 1.5 },
                { pitch: 70, startTime: 1.5, endTime: 2 }
            ],
            totalTime: 2,
            quantizationInfo: { stepsPerQuarter: 4 }
            };

        playSongButton.textContent = "play original";
        
        playSongButton.addEventListener("click", () => {
          const audioContext = Tone.context._context;
          if (audioContext.state !== "started") {
            audioContext.resume();
          }

          if (player.getPlayState() !== "started") {
            playSongButton.textContent = "playing original";
            player.start(elise).then(() => {playSongButton.textContent = "play original";});
          } else {
            player.stop();
            playSongButton.textContent = "play original";
          }
        });

        playSplitSongButton.textContent = "play geklebte st端cke";
        
        playSplitSongButton.addEventListener("click", () => {
          const audioContext = Tone.context._context;
          if (audioContext.state !== "started") {
            audioContext.resume();
          }

          if (player.getPlayState() !== "started") {
            playSplitSongButton.textContent = "playing geklebte st端cke";
            player.start(splitSong).then(() => {playSplitSongButton.textContent = "play geklebte st端cke";});
          } else {
            player.stop();
            playSplitSongButton.textContent = "play geklebte st端cke";
          }
        });

        playInterpolatedButton.textContent = "play merged";
        
        playInterpolatedButton.addEventListener("click", () => {
          const audioContext = Tone.context._context;
          if (audioContext.state !== "started") {
            audioContext.resume();
          }

          if (player.getPlayState() !== "started") {
            playInterpolatedButton.textContent = "playing merged";
            const mvae = new music_vae.MusicVAE(modelSelect.value);
            mvae.initialize().then(() => {
              console.log('initialized');
              let promises = [];
              for (let chunk of chunks) {
                promises.push(mvae.interpolate([chunk, jazzSeed], 3));
              }
              Promise.all(promises).then((values) => {
                let interpolated = values.map(val => val[1]);
                const song = core.sequences.concatenate(interpolated);
                console.log('concqt', song);
                player.start(song).then(() => {
                  playInterpolatedButton.textContent = "play merged";
                });
              });
            });
          } else {
            player.stop();
            playInterpolatedButton.textContent = "play merged";
          }
        });
      })();
    </script>
  </head>
  <body>
    <select id="modelSelect">
    </select>
    <button id="playSongButton">
      loading...
    </button>
    <button id="playSplitSongButton">
      loading...
    </button>
    <button id="playInterpolatedButton">
      loading...
    </button>
  </body>
</html>
